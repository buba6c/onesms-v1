import{s as r}from"./index-D5-bfYHE.js";const S=async()=>{try{const{data:{session:e}}=await r.auth.getSession(),a=new AbortController,o=setTimeout(()=>a.abort(),3e5);try{const t=await fetch("http://supabasekong-q84gs0csso48co84gw0s0o4g.46.202.171.108.sslip.io/functions/v1/sync-sms-activate",{method:"POST",headers:{Authorization:`Bearer ${(e==null?void 0:e.access_token)||"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2NTcyODA2MCwiZXhwIjo0OTIxNDAxNjYwLCJyb2xlIjoiYW5vbiJ9.x7SDkL_oGqzfqaPlV8bm9VKjOfMeuF_DPZtRRrKEboo"}`,apikey:"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2NTcyODA2MCwiZXhwIjo0OTIxNDAxNjYwLCJyb2xlIjoiYW5vbiJ9.x7SDkL_oGqzfqaPlV8bm9VKjOfMeuF_DPZtRRrKEboo","Content-Type":"application/json"},signal:a.signal});if(clearTimeout(o),!t.ok){const s=await t.text();throw console.error("❌ [SYNC] Erreur HTTP:",t.status,s),new Error(`HTTP ${t.status}: ${s}`)}return await t.json()}catch(t){throw clearTimeout(o),t}}catch(e){return console.error("❌ [SYNC] Erreur:",e),{success:!1,error:e.message||"Sync failed"}}},b=async e=>{let a=r.from("services").select("*").order("popularity_score",{ascending:!1}).order("total_available",{ascending:!1}).limit(1e4);(e==null?void 0:e.active)!==void 0&&(a=a.eq("active",e.active)),e!=null&&e.category&&(a=a.eq("category",e.category)),e!=null&&e.search&&(a=a.or(`name.ilike.%${e.search}%,display_name.ilike.%${e.search}%`));const{data:o,error:t}=await a;if(t)throw t;return o||[]},C=async(e,a)=>{const{data:o,error:t}=await r.from("services").update(a).eq("id",e).select().single();if(t)throw t;return o},_=async e=>{let a=r.from("countries").select("*").order("display_order",{ascending:!1}).order("available_numbers",{ascending:!1});(e==null?void 0:e.active)!==void 0&&(a=a.eq("active",e.active)),e!=null&&e.search&&(a=a.or(`name.ilike.%${e.search}%,code.ilike.%${e.search}%`));const{data:o,error:t}=await a;if(t)throw t;return o||[]},J=async(e,a)=>{const{data:o,error:t}=await r.from("countries").update(a).eq("id",e).select().single();if(t)throw t;return o},T=async()=>{const{data:e,error:a}=await r.from("sync_logs").select("*").order("started_at",{ascending:!1}).limit(1).single();return a?null:e},I=async()=>{const{count:e}=await r.from("services").select("*",{count:"exact",head:!0}),{count:a}=await r.from("services").select("*",{count:"exact",head:!0}).eq("active",!0),{data:o}=await r.from("services").select("popularity_score").limit(1e4),{data:t}=await r.from("countries").select("*").limit(1e4),{count:d}=await r.from("pricing_rules").select("*",{count:"exact",head:!0});let s=[],n=0;const u=1e3;let l=!0;for(;l;){const{data:c,error:i}=await r.from("pricing_rules").select("available_count").range(n*u,(n+1)*u-1);if(i){console.error("❌ [STATS] Erreur pagination pricing_rules:",i);break}c&&c.length>0?(s=s.concat(c),n++,l=c.length===u):l=!1}const g=e||0,h=a||0,p=(o==null?void 0:o.filter(c=>c.popularity_score>=50).length)||0,y=(t==null?void 0:t.length)||0,m=(t==null?void 0:t.filter(c=>c.active).length)||0,v=s.reduce((c,i)=>c+(i.available_count||0),0);return{totalServices:g,activeServices:h,popularServices:p,totalCountries:y,activeCountries:m,totalAvailable:v,pricingRulesCount:d}};export{I as a,T as b,J as c,_ as d,b as g,S as t,C as u};
