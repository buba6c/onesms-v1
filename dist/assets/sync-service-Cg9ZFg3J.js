import{s as r}from"./index-Bvkzdf-K.js";const w=async()=>{try{const{data:{session:e}}=await r.auth.getSession(),a=new AbortController,c=setTimeout(()=>a.abort(),3e5);try{const t=await fetch("https://api.onesms-sn.com/functions/v1/sync-sms-activate",{method:"POST",headers:{Authorization:`Bearer ${(e==null?void 0:e.access_token)||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0ZnFtYW12bWhkb2l4cWNiYmJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MjQ4MjgsImV4cCI6MjA3OTIwMDgyOH0.HQ5KsI86nrDidy4XLh1OnOSpM8c1ZnY3fYo-UF5Jtyg"}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0ZnFtYW12bWhkb2l4cWNiYmJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MjQ4MjgsImV4cCI6MjA3OTIwMDgyOH0.HQ5KsI86nrDidy4XLh1OnOSpM8c1ZnY3fYo-UF5Jtyg","Content-Type":"application/json"},signal:a.signal});if(clearTimeout(c),!t.ok){const n=await t.text();throw console.error("❌ [SYNC] Erreur HTTP:",t.status,n),new Error(`HTTP ${t.status}: ${n}`)}return await t.json()}catch(t){throw clearTimeout(c),t}}catch(e){return console.error("❌ [SYNC] Erreur:",e),{success:!1,error:e.message||"Sync failed"}}},S=async e=>{let a=r.from("services").select("*").order("popularity_score",{ascending:!1}).order("total_available",{ascending:!1}).limit(1e4);(e==null?void 0:e.active)!==void 0&&(a=a.eq("active",e.active)),e!=null&&e.category&&(a=a.eq("category",e.category)),e!=null&&e.search&&(a=a.or(`name.ilike.%${e.search}%,display_name.ilike.%${e.search}%`));const{data:c,error:t}=await a;if(t)throw t;return c||[]},b=async(e,a)=>{const{data:c,error:t}=await r.from("services").update(a).eq("id",e).select().single();if(t)throw t;return c},C=async e=>{let a=r.from("countries").select("*").order("display_order",{ascending:!1}).order("available_numbers",{ascending:!1});(e==null?void 0:e.active)!==void 0&&(a=a.eq("active",e.active)),e!=null&&e.search&&(a=a.or(`name.ilike.%${e.search}%,code.ilike.%${e.search}%`));const{data:c,error:t}=await a;if(t)throw t;return c||[]},J=async(e,a)=>{const{data:c,error:t}=await r.from("countries").update(a).eq("id",e).select().single();if(t)throw t;return c},M=async()=>{const{data:e,error:a}=await r.from("sync_logs").select("*").order("started_at",{ascending:!1}).limit(1).single();return a?null:e},O=async()=>{const{count:e}=await r.from("services").select("*",{count:"exact",head:!0}),{count:a}=await r.from("services").select("*",{count:"exact",head:!0}).eq("active",!0),{data:c}=await r.from("services").select("popularity_score").limit(1e4),{data:t}=await r.from("countries").select("*").limit(1e4),{count:g}=await r.from("pricing_rules").select("*",{count:"exact",head:!0});let n=[],i=0;const u=1e3;let l=!0;for(;l;){const{data:o,error:s}=await r.from("pricing_rules").select("available_count").range(i*u,(i+1)*u-1);if(s){console.error("❌ [STATS] Erreur pagination pricing_rules:",s);break}o&&o.length>0?(n=n.concat(o),i++,l=o.length===u):l=!1}const d=e||0,m=a||0,h=(c==null?void 0:c.filter(o=>o.popularity_score>=50).length)||0,p=(t==null?void 0:t.length)||0,y=(t==null?void 0:t.filter(o=>o.active).length)||0,I=n.reduce((o,s)=>o+(s.available_count||0),0);return{totalServices:d,activeServices:m,popularServices:h,totalCountries:p,activeCountries:y,totalAvailable:I,pricingRulesCount:g}};export{O as a,M as b,J as c,C as d,S as g,w as t,b as u};
