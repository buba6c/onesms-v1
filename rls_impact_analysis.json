{
  "timestamp": "2025-12-10T10:14:20.987Z",
  "tables_affected": [
    {
      "table": "activations",
      "rls_change": "RLS activÃ© (policies existaient dÃ©jÃ )",
      "current_policies": [
        "Admins can read all activations",
        "Users can read own activations",
        "Users insert own activations",
        "Service role can manage activations"
      ],
      "usage": [
        "CrÃ©ation d'activation (buy-sms-activate-number)",
        "VÃ©rification status (check-sms-activate-status)",
        "Dashboard utilisateur",
        "Page d'historique",
        "Stats admin"
      ],
      "impact": "ðŸŸ¢ AUCUN - Policies dÃ©jÃ  en place",
      "risk": "LOW"
    },
    {
      "table": "rental_logs",
      "rls_change": "RLS activÃ© + nouvelles policies",
      "new_policies": [
        "Users can read own rental logs",
        "Service role full access rental logs"
      ],
      "usage": [
        "Location de numÃ©ros (rent functions)",
        "Historique locations",
        "Calcul frozen_balance",
        "VÃ©rification status rent",
        "Cron jobs (check expirations)"
      ],
      "impact": "ðŸŸ¡ MOYEN - Edge Functions doivent utiliser service_role",
      "risk": "MEDIUM",
      "potential_break": [
        "Si Edge Functions utilisent anon key au lieu de service_role",
        "Si cron jobs n'ont pas les bonnes permissions"
      ]
    },
    {
      "table": "balance_operations",
      "rls_change": "RLS activÃ© + nouvelles policies",
      "new_policies": [
        "Users can read own balance operations",
        "Service role full access balance operations"
      ],
      "usage": [
        "Ajout/retrait de balance",
        "Historique transactions",
        "Dashboard wallet",
        "VÃ©rifications comptables",
        "Atomic operations (freeze/unfreeze)"
      ],
      "impact": "ðŸ”´ Ã‰LEVÃ‰ - OpÃ©rations critiques du wallet",
      "risk": "HIGH",
      "potential_break": [
        "atomic_freeze_balance() si pas SECURITY DEFINER",
        "atomic_unfreeze_balance() si pas SECURITY DEFINER",
        "atomic_commit() et atomic_refund()",
        "Paiements (PayDunya, MoneyFusion, etc.)"
      ]
    },
    {
      "table": "pricing_rules_archive",
      "rls_change": "RLS activÃ© + lecture publique",
      "new_policies": [
        "Public read pricing rules",
        "Service role full access pricing"
      ],
      "usage": [
        "Affichage des prix",
        "Calcul du coÃ»t",
        "Page services",
        "Validation prix avant achat"
      ],
      "impact": "ðŸŸ¢ AUCUN - Lecture publique autorisÃ©e",
      "risk": "LOW"
    },
    {
      "table": "email_campaigns",
      "rls_change": "RLS activÃ© + accÃ¨s admin seulement",
      "new_policies": [
        "Admins can manage email campaigns",
        "Service role full access campaigns"
      ],
      "usage": [
        "Panel admin - gestion campagnes",
        "Envoi d'emails marketing"
      ],
      "impact": "ðŸŸ¢ AUCUN - Uniquement pour admins",
      "risk": "LOW"
    },
    {
      "table": "email_logs",
      "rls_change": "RLS activÃ© + accÃ¨s admin seulement",
      "new_policies": [
        "Admins can read email logs",
        "Service role full access email logs"
      ],
      "usage": [
        "Panel admin - logs emails",
        "Debugging envois emails"
      ],
      "impact": "ðŸŸ¢ AUCUN - Uniquement pour admins",
      "risk": "LOW"
    }
  ],
  "views_affected": [
    {
      "view": "activation_stats",
      "usage": "Dashboard stats globales",
      "impact": "ðŸ”´ Ã‰LEVÃ‰ - Peut devenir vide si user non admin",
      "fix_needed": "OUI - Garder SECURITY DEFINER ou crÃ©er fonction",
      "recommendation": "CrÃ©er fonction get_activation_stats() avec SECURITY DEFINER"
    },
    {
      "view": "v_frozen_discrepancies",
      "usage": "Admin panel - vÃ©rification frozen_balance",
      "impact": "ðŸ”´ Ã‰LEVÃ‰ - Admins ne verront plus les users",
      "fix_needed": "OUI - Doit rester SECURITY DEFINER",
      "recommendation": "Garder SECURITY DEFINER + ajouter check admin"
    },
    {
      "view": "v_service_health",
      "usage": "Admin monitoring - santÃ© des services",
      "impact": "ðŸ”´ Ã‰LEVÃ‰ - Admins perdent visibilitÃ©",
      "fix_needed": "OUI - Doit rester SECURITY DEFINER",
      "recommendation": "Garder SECURITY DEFINER + check admin"
    },
    {
      "view": "v_frozen_balance_health",
      "usage": "Admin - vÃ©rification comptable",
      "impact": "ðŸ”´ Ã‰LEVÃ‰ - Critique pour comptabilitÃ©",
      "fix_needed": "OUI - Doit rester SECURITY DEFINER",
      "recommendation": "Garder SECURITY DEFINER"
    },
    {
      "view": "v_dashboard_stats",
      "usage": "Dashboard principal admin",
      "impact": "ðŸ”´ CRITIQUE - Dashboard admin cassÃ©",
      "fix_needed": "OUI - ABSOLUMENT NÃ‰CESSAIRE",
      "recommendation": "Garder SECURITY DEFINER + check admin strict"
    },
    {
      "view": "available_services",
      "usage": "Liste services disponibles (public)",
      "impact": "ðŸŸ¢ AUCUN - AccÃ¨s public OK",
      "fix_needed": "NON",
      "recommendation": "SECURITY INVOKER acceptable"
    }
  ],
  "potential_issues": [
    {
      "issue": "Views Admin (SECURITY INVOKER)",
      "severity": "CRITIQUE",
      "impact": "Dashboard admin complÃ¨tement cassÃ©",
      "affected": [
        "v_dashboard_stats",
        "v_frozen_discrepancies",
        "v_service_health",
        "v_frozen_balance_health"
      ],
      "solution": "NE PAS convertir en SECURITY INVOKER - Garder SECURITY DEFINER + check admin"
    },
    {
      "issue": "Fonctions SQL atomic_* sans SECURITY DEFINER",
      "severity": "CRITIQUE",
      "impact": "Wallet complÃ¨tement cassÃ©",
      "affected": [
        "atomic_freeze_balance()",
        "atomic_unfreeze_balance()",
        "atomic_commit()",
        "atomic_refund()"
      ],
      "solution": "VÃ©rifier que toutes ont SECURITY DEFINER"
    },
    {
      "issue": "Edge Functions avec anon key",
      "severity": "CRITIQUE",
      "impact": "Webhooks paiements cassÃ©s",
      "affected": [
        "paydunya-webhook",
        "moneyfusion-webhook",
        "get-rent-status",
        "cron-atomic-reliable"
      ],
      "solution": "Utiliser service_role key dans TOUS les webhooks et crons"
    },
    {
      "issue": "RLS sur balance_operations",
      "severity": "Ã‰LEVÃ‰",
      "impact": "Paiements peuvent Ã©chouer",
      "affected": [
        "Tous les paiements",
        "Recharges",
        "Atomic operations"
      ],
      "solution": "Edge Functions DOIVENT utiliser service_role key"
    }
  ],
  "edge_functions_impact": [
    {
      "function": "buy-sms-activate-number",
      "tables_used": [
        "activations",
        "balance_operations",
        "users"
      ],
      "current_key": "service_role (supposÃ©)",
      "impact": "ðŸŸ¡ MOYEN",
      "will_break": false,
      "reason": "Si utilise service_role key, OK. Si anon key, va casser.",
      "fix": "VÃ©rifier que SUPABASE_SERVICE_ROLE_KEY est utilisÃ©"
    },
    {
      "function": "check-sms-activate-status",
      "tables_used": [
        "activations"
      ],
      "current_key": "service_role (supposÃ©)",
      "impact": "ðŸŸ¢ FAIBLE",
      "will_break": false,
      "reason": "Lecture des activations avec policies existantes"
    },
    {
      "function": "paydunya-webhook / moneyfusion-webhook",
      "tables_used": [
        "balance_operations",
        "users",
        "transactions"
      ],
      "current_key": "service_role",
      "impact": "ðŸ”´ Ã‰LEVÃ‰",
      "will_break": true,
      "reason": "Webhooks externes DOIVENT utiliser service_role pour Ã©crire dans balance_operations",
      "fix": "CRITIQUE - VÃ©rifier service_role key dans tous les webhooks"
    },
    {
      "function": "get-rent-status / set-rent-status",
      "tables_used": [
        "rental_logs",
        "activations",
        "users"
      ],
      "current_key": "service_role (supposÃ©)",
      "impact": "ðŸ”´ Ã‰LEVÃ‰",
      "will_break": true,
      "reason": "Doit lire/Ã©crire rental_logs de tous les users",
      "fix": "CRITIQUE - Utiliser service_role key"
    },
    {
      "function": "cron-atomic-reliable / cron-check-pending-sms",
      "tables_used": [
        "activations",
        "rental_logs",
        "balance_operations"
      ],
      "current_key": "service_role",
      "impact": "ðŸ”´ CRITIQUE",
      "will_break": true,
      "reason": "Cron jobs doivent accÃ©der Ã  toutes les donnÃ©es",
      "fix": "CRITIQUE - VÃ©rifier Authorization header avec service_role"
    }
  ],
  "frontend_impact": [
    {
      "page": "Dashboard User",
      "queries": [
        "activations",
        "balance_operations",
        "rental_logs"
      ],
      "impact": "ðŸŸ¡ MOYEN",
      "will_break": false,
      "reason": "Users verront uniquement leurs donnÃ©es (OK)",
      "user_experience": "InchangÃ©"
    },
    {
      "page": "Services / Buy SMS",
      "queries": [
        "services",
        "pricing_rules_archive",
        "countries"
      ],
      "impact": "ðŸŸ¢ AUCUN",
      "will_break": false,
      "reason": "Lecture publique autorisÃ©e",
      "user_experience": "InchangÃ©"
    },
    {
      "page": "Admin Dashboard",
      "queries": [
        "v_dashboard_stats",
        "v_service_health",
        "all tables"
      ],
      "impact": "ðŸ”´ CRITIQUE",
      "will_break": true,
      "reason": "Views SECURITY INVOKER ne retourneront rien",
      "user_experience": "Dashboard vide ou erreurs",
      "fix": "URGENT - Garder SECURITY DEFINER sur views admin"
    },
    {
      "page": "Admin Users Management",
      "queries": [
        "users",
        "balance_operations"
      ],
      "impact": "ðŸ”´ Ã‰LEVÃ‰",
      "will_break": false,
      "reason": "DÃ©pend de comment les requÃªtes sont faites",
      "user_experience": "Peut voir uniquement son propre user",
      "fix": "Utiliser service_role key cÃ´tÃ© serveur ou Edge Functions"
    },
    {
      "page": "Wallet / Recharge",
      "queries": [
        "balance_operations",
        "transactions",
        "users"
      ],
      "impact": "ðŸŸ¡ MOYEN",
      "will_break": false,
      "reason": "Users voient leur historique uniquement (OK)",
      "user_experience": "InchangÃ©"
    }
  ],
  "recommendations": [
    {
      "priority": "ðŸ”´ CRITIQUE",
      "action": "NE PAS appliquer le script fix_rls_cloud_complete.sql tel quel",
      "reason": "Va casser le dashboard admin et les fonctions atomiques",
      "alternative": "Utiliser fix_rls_cloud_safe.sql (Ã  crÃ©er)"
    },
    {
      "priority": "ðŸ”´ CRITIQUE",
      "action": "Garder SECURITY DEFINER sur les views admin",
      "views": [
        "v_dashboard_stats",
        "v_frozen_discrepancies",
        "v_service_health",
        "v_frozen_balance_health",
        "v_frozen_balance_health_reconciliation",
        "v_provider_stats_24h",
        "v_country_health"
      ],
      "add_check": "Ajouter WHERE EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin')"
    },
    {
      "priority": "ðŸ”´ CRITIQUE",
      "action": "VÃ©rifier toutes les fonctions SQL atomic_*",
      "command": "SELECT proname, prosecdef FROM pg_proc WHERE proname LIKE 'atomic_%';",
      "ensure": "prosecdef = true (SECURITY DEFINER)"
    },
    {
      "priority": "ðŸŸ  Ã‰LEVÃ‰",
      "action": "Auditer toutes les Edge Functions",
      "check": "VÃ©rifier qu'elles utilisent SUPABASE_SERVICE_ROLE_KEY pour balance_operations et rental_logs",
      "files": "supabase/functions/*/index.ts"
    },
    {
      "priority": "ðŸŸ¡ MOYEN",
      "action": "Appliquer RLS de maniÃ¨re progressive",
      "steps": [
        "1. Activer RLS sur pricing_rules_archive, email_campaigns, email_logs (safe)",
        "2. Tester",
        "3. Activer RLS sur activations (policies dÃ©jÃ  lÃ )",
        "4. Tester",
        "5. Activer RLS sur rental_logs avec monitoring",
        "6. Activer RLS sur balance_operations en dernier"
      ]
    },
    {
      "priority": "ðŸŸ¢ FAIBLE",
      "action": "Convertir available_services en SECURITY INVOKER",
      "safe": true,
      "reason": "AccÃ¨s public, pas de risque"
    }
  ]
}