#!/bin/bash

# üöÄ PLAN COMPLET DE MIGRATION SUPABASE CLOUD ‚Üí COOLIFY
# Date: 8 d√©cembre 2025

echo "üöÄ MIGRATION SUPABASE CLOUD ‚Üí COOLIFY"
echo "======================================"
echo ""

# STATUT ACTUEL
echo "‚úÖ D√âJ√Ä FAIT:"
echo "   - ‚úÖ Base de donn√©es export√©e (194,763 lignes)"
echo "   - ‚úÖ Donn√©es import√©es: 22,696 lignes"
echo "   - ‚úÖ Sch√©ma complet cr√©√© (30 tables)"
echo "   - ‚úÖ Cl√©s API Coolify r√©cup√©r√©es"
echo ""

# CE QUI RESTE
echo "‚ö†Ô∏è  √Ä FAIRE:"
echo ""
echo "1Ô∏è‚É£  COMPL√âTER L'IMPORT DES DONN√âES (172,067 lignes manquantes)"
echo "   - balance_operations: 264 lignes manquantes"
echo "   - rental_logs: 62,450 lignes manquantes"
echo "   - pricing_rules_archive: 109,353 lignes manquantes"
echo "   üìù Script: node import_remaining_data.mjs"
echo ""

echo "2Ô∏è‚É£  MIGRATIONS SQL (34 migrations)"
echo "   - Appliquer toutes les migrations du dossier supabase/migrations/"
echo "   - V√©rifier que les fonctions SQL sont cr√©√©es"
echo "   üìù Commandes:"
echo "      ssh root@46.202.171.108"
echo "      cd /path/to/migrations"
echo "      docker exec -i supabase-db-h888cc0ck4w4o0kgw4kg84ks psql -U postgres -d postgres < migration.sql"
echo ""

echo "3Ô∏è‚É£  EDGE FUNCTIONS (61 fonctions)"
echo "   üì¶ Cat√©gories:"
echo "      - Paiements: 9 fonctions (PayDunya, MoneyFusion, Moneroo, PayTech)"
echo "      - SMS/Activations: 25 fonctions (SMS Activate, 5SIM)"
echo "      - Services: 8 fonctions (sync, countries)"
echo "      - Cron: 4 fonctions (atomic, pending-sms, wallet-health)"
echo "      - Webhooks: inclus dans paiements"
echo "      - Autres: 15 fonctions"
echo ""
echo "   üìù D√©ploiement:"
echo "      # 1. Configurer Supabase CLI pour Coolify"
echo "      supabase link --project-ref default"
echo "      # URL: http://supabasekong-h888cc0ck4w4o0kgw4kg84ks.46.202.171.108.sslip.io"
echo ""
echo "      # 2. D√©ployer toutes les fonctions"
echo "      cd supabase/functions"
echo "      supabase functions deploy --all"
echo ""

echo "4Ô∏è‚É£  SECRETS & ENVIRONNEMENT (27 variables)"
echo "   üìù √Ä configurer dans Coolify:"
echo "      - APIs SMS Activate"
echo "      - Cl√©s PayTech, Moneroo, MoneyFusion, PayDunya"
echo "      - Firebase (push notifications)"
echo "      - AWS (si utilis√©)"
echo "      - URLs de callbacks/webhooks"
echo ""

echo "5Ô∏è‚É£  CRON JOBS (3 t√¢ches planifi√©es)"
echo "   - cron-atomic-reliable"
echo "   - cron-check-pending-sms"
echo "   - cron-wallet-health"
echo ""
echo "   üìù Configuration dans Coolify ou via pg_cron"
echo ""

echo "6Ô∏è‚É£  AUTH & UTILISATEURS (64 utilisateurs)"
echo "   ‚úÖ D√©j√† import√©s"
echo "   ‚ö†Ô∏è  V√©rifier:"
echo "      - Email confirmation settings"
echo "      - SMTP configuration"
echo "      - Sessions actives"
echo ""

echo "7Ô∏è‚É£  STORAGE / BUCKETS"
echo "   ‚ÑπÔ∏è  Aucun bucket trouv√© (ou non accessible via API)"
echo "   üìù Si des fichiers existent, utiliser:"
echo "      supabase storage download-all"
echo "      # Puis uploader vers Coolify"
echo ""

echo "8Ô∏è‚É£  WEBHOOKS EXTERNES"
echo "   ‚ö†Ô∏è  Mettre √† jour les URLs dans:"
echo "      - PayDunya dashboard ‚Üí http://coolify.../paydunya-webhook"
echo "      - MoneyFusion dashboard ‚Üí http://coolify.../moneyfusion-webhook"
echo "      - Moneroo dashboard ‚Üí http://coolify.../moneroo-webhook"
echo "      - PayTech dashboard ‚Üí http://coolify.../paytech-ipn"
echo "      - SMS Activate ‚Üí http://coolify.../webhook-sms-activate"
echo ""

echo "9Ô∏è‚É£  FRONTEND & CONFIGURATION"
echo "   üìù Commandes:"
echo "      # 1. Basculer vers .env.coolify"
echo "      cp .env .env.backup"
echo "      cp .env.coolify .env"
echo ""
echo "      # 2. Tester en local"
echo "      npm run dev"
echo ""
echo "      # 3. Build & d√©ployer"
echo "      npm run build"
echo "      netlify deploy --prod"
echo ""

echo "üîü  TESTS & VALIDATION"
echo "   üìù Checklist:"
echo "      [ ] Login/Signup fonctionne"
echo "      [ ] Liste des services charge"
echo "      [ ] Achat d'activation fonctionne"
echo "      [ ] Paiement PayDunya fonctionne"
echo "      [ ] SMS re√ßus correctement"
echo "      [ ] Wallet balance correct"
echo "      [ ] Admin panel accessible"
echo "      [ ] Webhooks re√ßus et trait√©s"
echo ""

echo "======================================"
echo "üéØ PROCHAINE √âTAPE IMM√âDIATE:"
echo "   1. Importer les donn√©es manquantes (172K lignes)"
echo "   2. D√©ployer les Edge Functions"
echo "   3. Configurer les secrets"
echo ""
echo "Veux-tu commencer par l'import des donn√©es manquantes ? (Y/n)"
