ğŸ”¬ ANALYSE SQL ULTRA-PROFONDE
================================================================================
ğŸ“… 05/12/2025 10:35:26
================================================================================

ğŸ”Œ Connexion...

âœ… ConnectÃ© !

ğŸ“Š 1. STRUCTURE COMPLÃˆTE DES TABLES
--------------------------------------------------------------------------------

ğŸ“¦ TABLE: activation_packages
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ activations: integer NOT NULL [UNIQUE]
   â”œâ”€ price_xof: numeric NOT NULL
   â”œâ”€ price_eur: numeric NOT NULL
   â”œâ”€ price_usd: numeric NOT NULL
   â”œâ”€ is_popular: boolean NULL DEFAULT false
   â”œâ”€ savings_percentage: integer NULL DEFAULT 0
   â”œâ”€ is_active: boolean NULL DEFAULT true
   â”œâ”€ display_order: integer NULL DEFAULT 0
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: activations
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ user_id: uuid NOT NULL
   â”œâ”€ order_id: text NOT NULL [UNIQUE]
   â”œâ”€ phone: text NOT NULL
   â”œâ”€ service_code: text NOT NULL
   â”œâ”€ country_code: text NOT NULL
   â”œâ”€ operator: text NOT NULL
   â”œâ”€ price: numeric NULL
   â”œâ”€ status: text NOT NULL DEFAULT 'pending'::text
   â”œâ”€ sms_code: text NULL
   â”œâ”€ sms_text: text NULL
   â”œâ”€ sms_received_at: timestamp with time zone NULL
   â”œâ”€ expires_at: timestamp with time zone NOT NULL
   â”œâ”€ cancelled_at: timestamp with time zone NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ charged: boolean NULL DEFAULT false
   â”œâ”€ provider: text NULL DEFAULT 'sms-activate'::text
   â”œâ”€ external_id: text NULL
   â”œâ”€ frozen_amount: numeric NULL DEFAULT 0

ğŸ“¦ TABLE: activity_logs
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ action: text NOT NULL
   â”œâ”€ entity_type: text NULL
   â”œâ”€ entity_id: uuid NULL
   â”œâ”€ details: jsonb NULL
   â”œâ”€ ip_address: text NULL
   â”œâ”€ user_agent: text NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: balance_operations
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid() [PRIMARY KEY]
   â”œâ”€ user_id: uuid NOT NULL
   â”œâ”€ activation_id: uuid NULL
   â”œâ”€ rental_id: uuid NULL
   â”œâ”€ related_transaction_id: uuid NULL
   â”œâ”€ operation_type: text NOT NULL [CHECK]
   â”œâ”€ operation_type: text NOT NULL [CHECK]
   â”œâ”€ amount: numeric NOT NULL [CHECK]
   â”œâ”€ amount: numeric NOT NULL [CHECK]
   â”œâ”€ balance_before: numeric NOT NULL [CHECK]
   â”œâ”€ balance_after: numeric NOT NULL [CHECK]
   â”œâ”€ balance_after: numeric NOT NULL [CHECK]
   â”œâ”€ frozen_before: numeric NOT NULL [CHECK]
   â”œâ”€ frozen_after: numeric NOT NULL [CHECK]
   â”œâ”€ reason: text NULL
   â”œâ”€ metadata: jsonb NULL DEFAULT '{}'::jsonb
   â”œâ”€ created_at: timestamp without time zone NULL DEFAULT now()

ğŸ“¦ TABLE: contact_settings
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid() [PRIMARY KEY]
   â”œâ”€ email: character varying NOT NULL DEFAULT 'support@onesms-sn.com'::character varyi
   â”œâ”€ whatsapp: character varying NULL DEFAULT '+221 77 123 45 67'::character varying
   â”œâ”€ address: character varying NULL DEFAULT 'Dakar, SÃ©nÃ©gal'::character varying
   â”œâ”€ address_detail: character varying NULL DEFAULT 'Afrique de l''Ouest'::character varying
   â”œâ”€ hours_weekday: character varying NULL DEFAULT 'Lundi - Vendredi: 9h - 18h'::character 
   â”œâ”€ hours_saturday: character varying NULL DEFAULT 'Samedi: 9h - 14h'::character varying
   â”œâ”€ hours_sunday: character varying NULL DEFAULT 'Dimanche: FermÃ©'::character varying
   â”œâ”€ email_response_time: character varying NULL DEFAULT 'RÃ©ponse sous 24h'::character varying
   â”œâ”€ whatsapp_hours: character varying NULL DEFAULT 'Lun-Sam, 9h-18h'::character varying
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: countries
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ code: text NOT NULL [UNIQUE]
   â”œâ”€ name: text NOT NULL
   â”œâ”€ flag_emoji: text NULL DEFAULT 'ğŸŒ'::text
   â”œâ”€ active: boolean NULL DEFAULT true
   â”œâ”€ price_multiplier: numeric NULL DEFAULT 1.00
   â”œâ”€ available_numbers: integer NULL DEFAULT 0
   â”œâ”€ provider: text NULL DEFAULT '5sim'::text
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ success_rate: numeric NULL DEFAULT 99.00
   â”œâ”€ display_order: integer NULL DEFAULT 0
   â”œâ”€ popularity_score: integer NULL DEFAULT 0
   â”œâ”€ flag_url: text NULL

ğŸ“¦ TABLE: favorite_services
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ user_id: uuid NULL [UNIQUE]
   â”œâ”€ service_code: text NOT NULL [UNIQUE]
   â”œâ”€ service_name: text NOT NULL
   â”œâ”€ country: text NOT NULL [UNIQUE]
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: logs_provider
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ provider: text NOT NULL DEFAULT 'sms-activate'::text
   â”œâ”€ action: text NOT NULL
   â”œâ”€ request_url: text NOT NULL
   â”œâ”€ request_params: jsonb NULL
   â”œâ”€ response_status: integer NULL
   â”œâ”€ response_body: text NULL
   â”œâ”€ response_time_ms: integer NULL
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ activation_id: uuid NULL
   â”œâ”€ rental_id: uuid NULL
   â”œâ”€ error_message: text NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: notifications
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ title: text NOT NULL
   â”œâ”€ message: text NOT NULL
   â”œâ”€ type: text NULL DEFAULT 'info'::text [CHECK]
   â”œâ”€ read: boolean NULL DEFAULT false
   â”œâ”€ action_url: text NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: popular_services
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ service_code: text NOT NULL [UNIQUE]
   â”œâ”€ country_code: text NOT NULL [UNIQUE]
   â”œâ”€ type: text NOT NULL [CHECK]
   â”œâ”€ type: text NOT NULL [UNIQUE]
   â”œâ”€ display_order: integer NULL DEFAULT 0
   â”œâ”€ is_featured: boolean NULL DEFAULT false
   â”œâ”€ icon_url: text NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: pricing_rules_archive
   â”œâ”€ id: uuid NULL
   â”œâ”€ service_code: text NULL
   â”œâ”€ country_code: text NULL
   â”œâ”€ activation_cost: numeric NULL
   â”œâ”€ activation_price: numeric NULL
   â”œâ”€ rent_cost: numeric NULL
   â”œâ”€ rent_price: numeric NULL
   â”œâ”€ active: boolean NULL
   â”œâ”€ archived_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: rental_messages
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid() [PRIMARY KEY]
   â”œâ”€ rental_id: uuid NULL
   â”œâ”€ rent_id: text NOT NULL
   â”œâ”€ phone_from: text NULL
   â”œâ”€ text: text NOT NULL
   â”œâ”€ service: text NULL
   â”œâ”€ received_at: timestamp with time zone NOT NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: rentals
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid() [PRIMARY KEY]
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid()
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid()
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid()
   â”œâ”€ user_id: uuid NOT NULL
   â”œâ”€ rent_id: text NOT NULL [UNIQUE]
   â”œâ”€ phone: text NOT NULL
   â”œâ”€ service_code: text NOT NULL
   â”œâ”€ country_code: text NOT NULL
   â”œâ”€ operator: text NULL DEFAULT 'any'::text
   â”œâ”€ start_date: timestamp with time zone NOT NULL DEFAULT now()
   â”œâ”€ end_date: timestamp with time zone NOT NULL
   â”œâ”€ rent_hours: integer NOT NULL
   â”œâ”€ hourly_rate: numeric NULL
   â”œâ”€ total_cost: numeric NULL
   â”œâ”€ refund_amount: numeric NULL DEFAULT 0
   â”œâ”€ status: text NOT NULL DEFAULT 'active'::text [CHECK]
   â”œâ”€ last_message_date: timestamp with time zone NULL
   â”œâ”€ message_count: integer NULL DEFAULT 0
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ duration_hours: integer NULL
   â”œâ”€ expires_at: timestamp with time zone NULL
   â”œâ”€ rental_id: text NULL
   â”œâ”€ provider: text NULL DEFAULT 'sms-activate'::text
   â”œâ”€ frozen_amount: numeric NULL DEFAULT 0
   â”œâ”€ service: text NULL
   â”œâ”€ service_name: text NULL
   â”œâ”€ country: text NULL
   â”œâ”€ phone_number: text NULL
   â”œâ”€ price: numeric NULL
   â”œâ”€ sms_messages: jsonb NULL DEFAULT '[]'::jsonb
   â”œâ”€ metadata: jsonb NULL DEFAULT '{}'::jsonb

ğŸ“¦ TABLE: service_icons
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ service_code: text NOT NULL [UNIQUE]
   â”œâ”€ icon_url: text NULL
   â”œâ”€ icon_emoji: text NULL DEFAULT 'ğŸ“±'::text
   â”œâ”€ icon_type: text NULL DEFAULT 'emoji'::text [CHECK]
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: services
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ code: text NOT NULL [UNIQUE]
   â”œâ”€ code: text NOT NULL
   â”œâ”€ name: text NOT NULL
   â”œâ”€ display_name: text NULL
   â”œâ”€ category: text NULL DEFAULT 'other'::text
   â”œâ”€ icon: text NULL DEFAULT 'ğŸ“±'::text
   â”œâ”€ active: boolean NULL DEFAULT true
   â”œâ”€ popularity_score: integer NULL DEFAULT 0
   â”œâ”€ total_available: integer NULL DEFAULT 0
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ icon_url: text NULL
   â”œâ”€ provider: text NULL DEFAULT 'sms-activate'::text

ğŸ“¦ TABLE: sms_messages
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ virtual_number_id: uuid NULL
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ phone_number: text NOT NULL
   â”œâ”€ sender: text NULL
   â”œâ”€ content: text NOT NULL
   â”œâ”€ code: text NULL
   â”œâ”€ received_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: system_logs
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid() [PRIMARY KEY]
   â”œâ”€ level: text NOT NULL [CHECK]
   â”œâ”€ category: text NOT NULL [CHECK]
   â”œâ”€ message: text NOT NULL
   â”œâ”€ metadata: jsonb NULL DEFAULT '{}'::jsonb
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ ip_address: text NULL
   â”œâ”€ user_agent: text NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: system_settings
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ key: text NOT NULL [UNIQUE]
   â”œâ”€ value: text NULL
   â”œâ”€ category: text NULL
   â”œâ”€ description: text NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: transactions
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ type: text NOT NULL
   â”œâ”€ amount: numeric NOT NULL
   â”œâ”€ balance_before: numeric NOT NULL
   â”œâ”€ balance_after: numeric NOT NULL
   â”œâ”€ status: text NULL DEFAULT 'pending'::text [CHECK]
   â”œâ”€ description: text NULL
   â”œâ”€ reference: text NULL [UNIQUE]
   â”œâ”€ payment_method: text NULL [CHECK]
   â”œâ”€ payment_data: jsonb NULL
   â”œâ”€ virtual_number_id: uuid NULL
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ metadata: jsonb NULL DEFAULT '{}'::jsonb
   â”œâ”€ related_rental_id: uuid NULL
   â”œâ”€ related_activation_id: uuid NULL

ğŸ“¦ TABLE: users
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ email: text NOT NULL [UNIQUE]
   â”œâ”€ name: text NULL
   â”œâ”€ phone: text NULL
   â”œâ”€ avatar_url: text NULL
   â”œâ”€ role: text NULL DEFAULT 'user'::text [CHECK]
   â”œâ”€ balance: numeric NULL DEFAULT 0.00
   â”œâ”€ language: text NULL DEFAULT 'fr'::text [CHECK]
   â”œâ”€ notifications_enabled: boolean NULL DEFAULT true
   â”œâ”€ email_notifications: boolean NULL DEFAULT true
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ frozen_balance: numeric NULL DEFAULT 0.00 [CHECK]

ğŸ“¦ TABLE: virtual_numbers
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4()
   â”œâ”€ id: uuid NOT NULL DEFAULT uuid_generate_v4() [PRIMARY KEY]
   â”œâ”€ user_id: uuid NULL
   â”œâ”€ phone_number: text NOT NULL
   â”œâ”€ country: text NOT NULL
   â”œâ”€ country_code: text NOT NULL
   â”œâ”€ operator: text NULL
   â”œâ”€ service: text NOT NULL
   â”œâ”€ service_name: text NULL
   â”œâ”€ price: numeric NOT NULL
   â”œâ”€ type: text NULL DEFAULT 'activation'::text [CHECK]
   â”œâ”€ status: text NULL DEFAULT 'active'::text [CHECK]
   â”œâ”€ activation_code: text NULL
   â”œâ”€ sms_received: ARRAY NULL
   â”œâ”€ expires_at: timestamp with time zone NULL
   â”œâ”€ external_id: text NULL [UNIQUE]
   â”œâ”€ provider: text NULL DEFAULT '5sim'::text
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()
   â”œâ”€ updated_at: timestamp with time zone NULL DEFAULT now()

ğŸ“¦ TABLE: webhook_logs
   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid() [PRIMARY KEY]
   â”œâ”€ activation_id: text NOT NULL
   â”œâ”€ payload: jsonb NOT NULL
   â”œâ”€ received_at: timestamp with time zone NOT NULL
   â”œâ”€ ip_address: text NULL
   â”œâ”€ processed: boolean NULL DEFAULT false
   â”œâ”€ created_at: timestamp with time zone NULL DEFAULT now()

ğŸ”— 2. RELATIONS (FOREIGN KEYS)
--------------------------------------------------------------------------------
ğŸ“Š Total: 19 relations


ğŸ“¦ activations:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ activity_logs:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL

ğŸ“¦ balance_operations:
   â”œâ”€ activation_id â†’ activations.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL
   â”œâ”€ rental_id â†’ rentals.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ favorite_services:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ logs_provider:
   â”œâ”€ activation_id â†’ activations.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL
   â”œâ”€ rental_id â†’ rentals.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL

ğŸ“¦ notifications:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ rental_messages:
   â”œâ”€ rental_id â†’ rentals.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ service_icons:
   â”œâ”€ service_code â†’ services.code
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ sms_messages:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE
   â”œâ”€ virtual_number_id â†’ virtual_numbers.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

ğŸ“¦ system_logs:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL

ğŸ“¦ transactions:
   â”œâ”€ related_activation_id â†’ activations.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE
   â”œâ”€ virtual_number_id â†’ virtual_numbers.id
   â”‚  UPDATE: NO ACTION, DELETE: SET NULL

ğŸ“¦ virtual_numbers:
   â”œâ”€ user_id â†’ users.id
   â”‚  UPDATE: NO ACTION, DELETE: CASCADE

âš™ï¸  3. TRIGGERS DÃ‰TAILLÃ‰S
--------------------------------------------------------------------------------
ğŸ“Š Total: 16 triggers


ğŸ“¦ activation_packages:

   âš¡ trigger_update_activation_packages_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_activation_packages_updated_at()...

ğŸ“¦ activations:

   âš¡ activations_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_activations_updated_at()...

   âš¡ protect_frozen_amount_activations
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION prevent_direct_frozen_amount_update()...

ğŸ“¦ contact_settings:

   âš¡ contact_settings_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_contact_settings_updated_at()...

ğŸ“¦ countries:

   âš¡ update_countries_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ popular_services:

   âš¡ update_popular_services_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ rentals:

   âš¡ protect_frozen_amount_rentals
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION prevent_direct_frozen_amount_update()...

   âš¡ update_rentals_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

   âš¡ update_rentals_updated_at_trigger
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_rentals_updated_at()...

ğŸ“¦ service_icons:

   âš¡ update_service_icons_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ services:

   âš¡ update_services_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ system_settings:

   âš¡ update_system_settings_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ transactions:

   âš¡ update_transactions_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ users:

   âš¡ prevent_direct_frozen_amount_update
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION prevent_direct_frozen_amount_update()...

   âš¡ update_users_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ“¦ virtual_numbers:

   âš¡ update_virtual_numbers_updated_at
      â”œâ”€ Timing: BEFORE UPDATE
      â”œâ”€ Type: ROW
      â””â”€ Action: EXECUTE FUNCTION update_updated_at_column()...

ğŸ”§ 4. FONCTIONS STOCKÃ‰ES (STORED FUNCTIONS)
--------------------------------------------------------------------------------
ğŸ“Š Total: 49 fonctions


1. ğŸ”§ admin_add_credit
   â”œâ”€ Arguments: p_user_id uuid, p_amount numeric, p_admin_note text DEFAULT NULL::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.admin_add_credit(p_user_id uuid, p_amount numeric, p_admin_note text DEFAULT NULL::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_new_balance DECIMAL;
        v_transaction_id UUID;
      BEGIN
        -- Validation
        IF p_amount IS NULL OR p_amount <= 0 THEN
          RAISE EXCEPTION 'Amount must be positive: %', p_amount;
        END IF;
        
        -- 1. LOCK USER et lire balance actuel
        SELECT id, balance, frozen_balance, email
        INTO v_user
        FROM users
        WHERE id = p_user_id
      ... (56 lignes supplÃ©mentaires)

2. ğŸ”§ atomic_commit
   â”œâ”€ Arguments: p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_transaction_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.atomic_commit(p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_transaction_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_frozen_amount DECIMAL;
        v_commit DECIMAL;
        v_new_balance DECIMAL;
        v_new_frozen DECIMAL;
      BEGIN
        -- 1. LOCK USER
        SELECT balance, frozen_balance
        INTO v_user
        FROM users
        WHERE id = p_user_id
        FOR UPDATE;
        
        IF NOT FOUND THEN
      ... (116 lignes supplÃ©mentaires)

3. ğŸ”§ atomic_commit
   â”œâ”€ Arguments: p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT 'Service completed'::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.atomic_commit(p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT 'Service completed'::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_frozen_amount DECIMAL := 0;
      BEGIN
        SELECT id, balance, frozen_balance INTO v_user
        FROM users WHERE id = p_user_id FOR UPDATE;
      
        IF NOT FOUND THEN
          RETURN json_build_object('success', false, 'error', 'User not found');
        END IF;
      
        IF p_activation_id IS NOT NULL THEN
          SELECT frozen_amount INTO v_frozen_amount
          FROM activations
          WHERE id = p_activation_id AND user_id = p_user_id FOR UPDATE;
      ... (46 lignes supplÃ©mentaires)

4. ğŸ”§ atomic_freeze
   â”œâ”€ Arguments: p_user_id uuid, p_amount numeric, p_transaction_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.atomic_freeze(p_user_id uuid, p_amount numeric, p_transaction_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_available DECIMAL;
        v_new_frozen DECIMAL;
      BEGIN
        -- Validation
        IF p_amount <= 0 THEN
          RAISE EXCEPTION 'Amount must be positive: %', p_amount;
        END IF;
        
        -- 1. LOCK USER (FOR UPDATE - empÃªche race conditions)
        SELECT balance, frozen_balance
        INTO v_user
        FROM users
        WHERE id = p_user_id
      ... (74 lignes supplÃ©mentaires)

5. ğŸ”§ atomic_refund
   â”œâ”€ Arguments: p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_transaction_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.atomic_refund(p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_transaction_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_frozen_amount DECIMAL;
        v_refund DECIMAL;
        v_new_frozen DECIMAL;
      BEGIN
        -- 1. LOCK USER
        SELECT balance, frozen_balance
        INTO v_user
        FROM users
        WHERE id = p_user_id
        FOR UPDATE;
        
        IF NOT FOUND THEN
          RAISE EXCEPTION 'User not found: %', p_user_id;
      ... (116 lignes supplÃ©mentaires)

6. ğŸ”§ atomic_refund
   â”œâ”€ Arguments: p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT 'Refund'::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.atomic_refund(p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT 'Refund'::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_result JSON;
      BEGIN
        v_result := secure_unfreeze_balance(
          p_user_id, p_activation_id, p_rental_id, TRUE, p_reason
        );
      
        IF (v_result->>'success')::boolean THEN
          IF p_activation_id IS NOT NULL THEN
            UPDATE activations
            SET status = CASE 
                WHEN status = 'pending' THEN 'timeout'
                WHEN status = 'waiting' THEN 'cancelled'
                ELSE status
              END,
      ... (21 lignes supplÃ©mentaires)

7. ğŸ”§ atomic_refund_direct
   â”œâ”€ Arguments: p_user_id uuid, p_amount numeric, p_transaction_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.atomic_refund_direct(p_user_id uuid, p_amount numeric, p_transaction_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text)
       RETURNS json
       LANGUAGE plpgsql
      AS $function$
      DECLARE
        v_user RECORD;
        v_amount_to_refund DECIMAL;
        v_new_frozen DECIMAL;
      BEGIN
        -- Validation
        IF p_amount IS NULL OR p_amount <= 0 THEN
          RAISE EXCEPTION 'Amount must be positive: %', p_amount;
        END IF;
        
        -- 1. LOCK USER et lire les valeurs
        SELECT balance, frozen_balance
        INTO v_user
        FROM users
        WHERE id = p_user_id
        FOR UPDATE;
      ... (61 lignes supplÃ©mentaires)

8. ğŸ”§ bytea_to_text
   â”œâ”€ Arguments: data bytea
   â”œâ”€ Retour: text
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: IMMUTABLE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.bytea_to_text(data bytea)
       RETURNS text
       LANGUAGE c
       IMMUTABLE STRICT
      AS '$libdir/http', $function$bytea_to_text$function$
      

9. ğŸ”§ cleanup_old_logs
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: void
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.cleanup_old_logs()
       RETURNS void
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      BEGIN
        DELETE FROM system_logs
        WHERE created_at < NOW() - INTERVAL '30 days';
      END;
      $function$
      

10. ğŸ”§ cleanup_old_provider_logs
   â”œâ”€ Arguments: retention_days integer DEFAULT 90
   â”œâ”€ Retour: integer
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.cleanup_old_provider_logs(retention_days integer DEFAULT 90)
       RETURNS integer
       LANGUAGE plpgsql
      AS $function$
      DECLARE
        deleted_count INTEGER;
      BEGIN
        DELETE FROM logs_provider
        WHERE created_at < NOW() - (retention_days || ' days')::INTERVAL;
        
        GET DIAGNOSTICS deleted_count = ROW_COUNT;
        
        RETURN deleted_count;
      END;
      $function$
      

11. ğŸ”§ expire_rentals
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: integer
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.expire_rentals()
       RETURNS integer
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
          expired_count INTEGER;
      BEGIN
          -- Marquer comme expirÃ©es les locations dont la date est dÃ©passÃ©e
          UPDATE public.rentals
          SET status = 'expired'
          WHERE status = 'active'
          AND expires_at < now();
          
          GET DIAGNOSTICS expired_count = ROW_COUNT;
          
          RETURN expired_count;
      END;
      $function$
      

12. ğŸ”§ fix_frozen_balance_discrepancy
   â”œâ”€ Arguments: p_user_id uuid
   â”œâ”€ Retour: jsonb
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.fix_frozen_balance_discrepancy(p_user_id uuid)
       RETURNS jsonb
       LANGUAGE plpgsql
      AS $function$
      DECLARE
          v_calculated DECIMAL(10,2);
          v_actual DECIMAL(10,2);
          v_balance DECIMAL(10,2);
          v_activation_frozen DECIMAL(10,2);
          v_rental_frozen DECIMAL(10,2);
      BEGIN
          -- Calculer ce que frozen_balance DEVRAIT Ãªtre (activations)
          SELECT COALESCE(SUM(frozen_amount), 0)
          INTO v_activation_frozen
          FROM activations
          WHERE user_id = p_user_id
          AND status IN ('pending', 'waiting')
          AND frozen_amount > 0;
          
          -- Calculer ce que frozen_balance DEVRAIT Ãªtre (rentals)
      ... (65 lignes supplÃ©mentaires)

13. ğŸ”§ get_cron_jobs
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: TABLE(job_id bigint, job_name text, schedule text, is_active boolean)
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.get_cron_jobs()
       RETURNS TABLE(job_id bigint, job_name text, schedule text, is_active boolean)
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      BEGIN
        RETURN QUERY
        SELECT 
          j.jobid,
          j.jobname::text,
          j.schedule::text,
          j.active
        FROM cron.job j
        ORDER BY j.jobname;
      END;
      $function$
      

14. ğŸ”§ get_setting
   â”œâ”€ Arguments: setting_key character varying
   â”œâ”€ Retour: text
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.get_setting(setting_key character varying)
       RETURNS text
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      BEGIN
        RETURN (SELECT value FROM system_settings WHERE key = setting_key);
      END;
      $function$
      

15. ğŸ”§ handle_new_user
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.handle_new_user()
       RETURNS trigger
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      BEGIN
        -- Auto-confirmer l'email immÃ©diatement
        UPDATE auth.users
        SET email_confirmed_at = NOW()
        WHERE id = NEW.id AND email_confirmed_at IS NULL;
        
        -- Supprimer d'abord l'ancien enregistrement s'il existe avec le mÃªme email mais un ID diffÃ©rent
        DELETE FROM public.users 
        WHERE email = NEW.email AND id != NEW.id;
        
        -- InsÃ©rer ou mettre Ã  jour l'utilisateur
        INSERT INTO public.users (id, email, name, avatar_url, role, balance, created_at, updated_at)
        VALUES (
          NEW.id,
          NEW.email,
      ... (22 lignes supplÃ©mentaires)

16. ğŸ”§ http
   â”œâ”€ Arguments: request http_request
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http(request http_request)
       RETURNS http_response
       LANGUAGE c
      AS '$libdir/http', $function$http_request$function$
      

17. ğŸ”§ http_delete
   â”œâ”€ Arguments: uri character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_delete(uri character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('DELETE', $1, NULL, NULL, NULL)::public.http_request) $function$
      

18. ğŸ”§ http_delete
   â”œâ”€ Arguments: uri character varying, content character varying, content_type character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_delete(uri character varying, content character varying, content_type character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('DELETE', $1, NULL, $3, $2)::public.http_request) $function$
      

19. ğŸ”§ http_get
   â”œâ”€ Arguments: uri character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_get(uri character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('GET', $1, NULL, NULL, NULL)::public.http_request) $function$
      

20. ğŸ”§ http_get
   â”œâ”€ Arguments: uri character varying, data jsonb
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_get(uri character varying, data jsonb)
       RETURNS http_response
       LANGUAGE sql
      AS $function$
              SELECT public.http(('GET', $1 || '?' || public.urlencode($2), NULL, NULL, NULL)::public.http_request)
          $function$
      

21. ğŸ”§ http_head
   â”œâ”€ Arguments: uri character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_head(uri character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('HEAD', $1, NULL, NULL, NULL)::public.http_request) $function$
      

22. ğŸ”§ http_header
   â”œâ”€ Arguments: field character varying, value character varying
   â”œâ”€ Retour: http_header
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_header(field character varying, value character varying)
       RETURNS http_header
       LANGUAGE sql
      AS $function$ SELECT $1, $2 $function$
      

23. ğŸ”§ http_list_curlopt
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: TABLE(curlopt text, value text)
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_list_curlopt()
       RETURNS TABLE(curlopt text, value text)
       LANGUAGE c
      AS '$libdir/http', $function$http_list_curlopt$function$
      

24. ğŸ”§ http_patch
   â”œâ”€ Arguments: uri character varying, content character varying, content_type character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_patch(uri character varying, content character varying, content_type character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('PATCH', $1, NULL, $3, $2)::public.http_request) $function$
      

25. ğŸ”§ http_post
   â”œâ”€ Arguments: uri character varying, content character varying, content_type character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_post(uri character varying, content character varying, content_type character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('POST', $1, NULL, $3, $2)::public.http_request) $function$
      

26. ğŸ”§ http_post
   â”œâ”€ Arguments: uri character varying, data jsonb
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_post(uri character varying, data jsonb)
       RETURNS http_response
       LANGUAGE sql
      AS $function$
              SELECT public.http(('POST', $1, NULL, 'application/x-www-form-urlencoded', public.urlencode($2))::public.http_request)
          $function$
      

27. ğŸ”§ http_put
   â”œâ”€ Arguments: uri character varying, content character varying, content_type character varying
   â”œâ”€ Retour: http_response
   â”œâ”€ Langage: sql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_put(uri character varying, content character varying, content_type character varying)
       RETURNS http_response
       LANGUAGE sql
      AS $function$ SELECT public.http(('PUT', $1, NULL, $3, $2)::public.http_request) $function$
      

28. ğŸ”§ http_reset_curlopt
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: boolean
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_reset_curlopt()
       RETURNS boolean
       LANGUAGE c
      AS '$libdir/http', $function$http_reset_curlopt$function$
      

29. ğŸ”§ http_set_curlopt
   â”œâ”€ Arguments: curlopt character varying, value character varying
   â”œâ”€ Retour: boolean
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.http_set_curlopt(curlopt character varying, value character varying)
       RETURNS boolean
       LANGUAGE c
      AS '$libdir/http', $function$http_set_curlopt$function$
      

30. ğŸ”§ lock_user_wallet
   â”œâ”€ Arguments: p_user_id uuid
   â”œâ”€ Retour: TABLE(balance numeric, frozen_balance numeric, available_balance numeric)
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.lock_user_wallet(p_user_id uuid)
       RETURNS TABLE(balance numeric, frozen_balance numeric, available_balance numeric)
       LANGUAGE plpgsql
      AS $function$
      BEGIN
        RETURN QUERY
        SELECT 
          u.balance, 
          u.frozen_balance,
          u.balance - u.frozen_balance AS available_balance
        FROM users u
        WHERE u.id = p_user_id
        FOR UPDATE;
      END;
      $function$
      

31. ğŸ”§ log_event
   â”œâ”€ Arguments: p_level text, p_category text, p_message text, p_metadata jsonb DEFAULT '{}'::jsonb, p_user_id uuid DEFAULT NULL::uuid
   â”œâ”€ Retour: uuid
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.log_event(p_level text, p_category text, p_message text, p_metadata jsonb DEFAULT '{}'::jsonb, p_user_id uuid DEFAULT NULL::uuid)
       RETURNS uuid
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_log_id UUID;
      BEGIN
        INSERT INTO system_logs (level, category, message, metadata, user_id)
        VALUES (p_level, p_category, p_message, p_metadata, p_user_id)
        RETURNING id INTO v_log_id;
        
        RETURN v_log_id;
      END;
      $function$
      

32. ğŸ”§ prevent_direct_frozen_amount_update
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.prevent_direct_frozen_amount_update()
       RETURNS trigger
       LANGUAGE plpgsql
      AS $function$
      BEGIN
        -- Permettre aux fonctions SECURITY DEFINER (atomic_*) d'opÃ©rer
        IF current_user = 'postgres' THEN
          RETURN NEW;
        END IF;
        
        -- Bloquer les modifications directes
        IF OLD.frozen_balance IS DISTINCT FROM NEW.frozen_balance THEN
          RAISE EXCEPTION 'Direct update of frozen_amount is forbidden. Use atomic_freeze, atomic_commit, or atomic_refund functions.';
        END IF;
        
        RETURN NEW;
      END;
      $function$
      

33. ğŸ”§ process_expired_activations
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.process_expired_activations()
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_activation RECORD;
        v_user RECORD;
        v_processed_count INTEGER := 0;
        v_refunded_total DECIMAL := 0;
        v_errors INTEGER := 0;
        v_result JSON;
      BEGIN
        RAISE NOTICE 'Starting expired activations processing at %', NOW();
        
        FOR v_activation IN
          SELECT id, user_id, price, frozen_amount, order_id, service_code, expires_at
          FROM activations 
          WHERE status IN ('pending', 'waiting') 
            AND expires_at < NOW()
      ... (66 lignes supplÃ©mentaires)

34. ğŸ”§ reconcile_frozen_balance
   â”œâ”€ Arguments: p_user_id uuid
   â”œâ”€ Retour: TABLE(calculated_frozen numeric, actual_frozen numeric, difference numeric, needs_correction boolean)
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.reconcile_frozen_balance(p_user_id uuid)
       RETURNS TABLE(calculated_frozen numeric, actual_frozen numeric, difference numeric, needs_correction boolean)
       LANGUAGE plpgsql
      AS $function$
      DECLARE
          v_calculated DECIMAL(10,2);
          v_actual DECIMAL(10,2);
          v_activation_frozen DECIMAL(10,2);
          v_rental_frozen DECIMAL(10,2);
      BEGIN
          -- Calculer la somme des frozen_amount pour les activations actives
          SELECT COALESCE(SUM(frozen_amount), 0)
          INTO v_activation_frozen
          FROM activations
          WHERE user_id = p_user_id
          AND status IN ('pending', 'waiting')
          AND frozen_amount > 0;
          
          -- Calculer la somme des frozen_amount pour les rentals actives
          SELECT COALESCE(SUM(frozen_amount), 0)
      ... (23 lignes supplÃ©mentaires)

35. ğŸ”§ reconcile_orphan_freezes
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: TABLE(activation_id uuid, user_id uuid, frozen_amount numeric, status text, refund_applied boolean, error text)
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.reconcile_orphan_freezes()
       RETURNS TABLE(activation_id uuid, user_id uuid, frozen_amount numeric, status text, refund_applied boolean, error text)
       LANGUAGE plpgsql
       SECURITY DEFINER
       SET search_path TO 'public'
      AS $function$
      DECLARE
        v_activation RECORD;
        v_refund_exists BOOLEAN;
        v_refund_result jsonb;
      BEGIN
        FOR v_activation IN
          SELECT a.id, a.user_id, a.frozen_amount, a.status
          FROM activations a
          WHERE a.frozen_amount > 0
            AND a.status IN ('timeout', 'failed', 'cancelled')
            AND a.charged = false
          ORDER BY a.created_at DESC
          LIMIT 50
        LOOP
      ... (42 lignes supplÃ©mentaires)

36. ğŸ”§ reconcile_rentals_orphan_freezes
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: TABLE(rental_id uuid, user_id uuid, frozen_amount numeric, status text, refund_applied boolean, error text)
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.reconcile_rentals_orphan_freezes()
       RETURNS TABLE(rental_id uuid, user_id uuid, frozen_amount numeric, status text, refund_applied boolean, error text)
       LANGUAGE plpgsql
       SECURITY DEFINER
       SET search_path TO 'public'
      AS $function$
      DECLARE
        v_rental RECORD;
        v_refund_exists BOOLEAN;
        v_refund_result jsonb;
      BEGIN
        FOR v_rental IN
          SELECT r.id, r.user_id, r.frozen_amount, r.status
          FROM rentals r
          WHERE r.frozen_amount > 0
            AND r.status IN ('expired', 'failed', 'cancelled')
          ORDER BY r.created_at DESC
          LIMIT 50
        LOOP
          SELECT EXISTS(
      ... (41 lignes supplÃ©mentaires)

37. ğŸ”§ secure_freeze_balance
   â”œâ”€ Arguments: p_user_id uuid, p_amount numeric, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT 'Balance freeze'::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.secure_freeze_balance(p_user_id uuid, p_amount numeric, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT 'Balance freeze'::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_available DECIMAL;
      BEGIN
        SELECT id, balance, frozen_balance INTO v_user
        FROM users WHERE id = p_user_id FOR UPDATE;
      
        IF NOT FOUND THEN
          RETURN json_build_object('success', false, 'error', 'User not found');
        END IF;
      
        v_available := v_user.balance - COALESCE(v_user.frozen_balance, 0);
      
        IF v_available < p_amount THEN
          RETURN json_build_object('success', false, 'error', 'Insufficient balance');
      ... (27 lignes supplÃ©mentaires)

38. ğŸ”§ secure_unfreeze_balance
   â”œâ”€ Arguments: p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_refund_to_balance boolean DEFAULT false, p_refund_reason text DEFAULT 'Refund'::text
   â”œâ”€ Retour: json
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.secure_unfreeze_balance(p_user_id uuid, p_activation_id uuid DEFAULT NULL::uuid, p_rental_id uuid DEFAULT NULL::uuid, p_refund_to_balance boolean DEFAULT false, p_refund_reason text DEFAULT 'Refund'::text)
       RETURNS json
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        v_user RECORD;
        v_frozen_amount DECIMAL := 0;
        v_operation_type TEXT;
      BEGIN
        SELECT id, balance, frozen_balance INTO v_user
        FROM users WHERE id = p_user_id FOR UPDATE;
      
        IF NOT FOUND THEN
          RETURN json_build_object('success', false, 'error', 'User not found');
        END IF;
      
        IF p_activation_id IS NOT NULL THEN
          SELECT frozen_amount INTO v_frozen_amount
          FROM activations
      ... (41 lignes supplÃ©mentaires)

39. ğŸ”§ text_to_bytea
   â”œâ”€ Arguments: data text
   â”œâ”€ Retour: bytea
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: IMMUTABLE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.text_to_bytea(data text)
       RETURNS bytea
       LANGUAGE c
       IMMUTABLE STRICT
      AS '$libdir/http', $function$text_to_bytea$function$
      

40. ğŸ”§ transfer_service_stock
   â”œâ”€ Arguments: source_code text, target_code text
   â”œâ”€ Retour: void
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.transfer_service_stock(source_code text, target_code text)
       RETURNS void
       LANGUAGE plpgsql
      AS $function$
      BEGIN
        -- VÃ©rifier si les deux services existent
        IF NOT EXISTS (SELECT 1 FROM services WHERE code = source_code) THEN
          RAISE NOTICE 'Service source % n''existe pas, skip', source_code;
          RETURN;
        END IF;
        
        IF NOT EXISTS (SELECT 1 FROM services WHERE code = target_code) THEN
          RAISE NOTICE 'Service target % n''existe pas, skip', target_code;
          RETURN;
        END IF;
        
        -- TransfÃ©rer le total_available
        UPDATE services
        SET total_available = COALESCE(total_available, 0) + (
          SELECT COALESCE(total_available, 0) 
      ... (33 lignes supplÃ©mentaires)

41. ğŸ”§ update_activation_packages_updated_at
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.update_activation_packages_updated_at()
       RETURNS trigger
       LANGUAGE plpgsql
      AS $function$
      BEGIN
          NEW.updated_at = NOW();
          RETURN NEW;
      END;
      $function$
      

42. ğŸ”§ update_activations_updated_at
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.update_activations_updated_at()
       RETURNS trigger
       LANGUAGE plpgsql
      AS $function$
      BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
      END;
      $function$
      

43. ğŸ”§ update_contact_settings_updated_at
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.update_contact_settings_updated_at()
       RETURNS trigger
       LANGUAGE plpgsql
      AS $function$
      BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
      END;
      $function$
      

44. ğŸ”§ update_rentals_updated_at
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.update_rentals_updated_at()
       RETURNS trigger
       LANGUAGE plpgsql
      AS $function$
      BEGIN
          NEW.updated_at = now();
          RETURN NEW;
      END;
      $function$
      

45. ğŸ”§ update_setting
   â”œâ”€ Arguments: setting_key character varying, setting_value text
   â”œâ”€ Retour: boolean
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.update_setting(setting_key character varying, setting_value text)
       RETURNS boolean
       LANGUAGE plpgsql
       SECURITY DEFINER
      AS $function$
      DECLARE
        user_role VARCHAR;
      BEGIN
        -- Check if user is admin
        SELECT role INTO user_role FROM users WHERE id = auth.uid();
        
        IF user_role != 'admin' THEN
          RAISE EXCEPTION 'Only admins can update settings';
        END IF;
        
        -- Update setting
        UPDATE system_settings 
        SET value = setting_value, updated_at = NOW()
        WHERE key = setting_key;
        
      ... (4 lignes supplÃ©mentaires)

46. ğŸ”§ update_updated_at_column
   â”œâ”€ Arguments: none
   â”œâ”€ Retour: trigger
   â”œâ”€ Langage: plpgsql
   â”œâ”€ VolatilitÃ©: VOLATILE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.update_updated_at_column()
       RETURNS trigger
       LANGUAGE plpgsql
      AS $function$
      BEGIN
          NEW.updated_at = NOW();
          RETURN NEW;
      END;
      $function$
      

47. ğŸ”§ urlencode
   â”œâ”€ Arguments: data jsonb
   â”œâ”€ Retour: text
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: IMMUTABLE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.urlencode(data jsonb)
       RETURNS text
       LANGUAGE c
       IMMUTABLE STRICT
      AS '$libdir/http', $function$urlencode_jsonb$function$
      

48. ğŸ”§ urlencode
   â”œâ”€ Arguments: string character varying
   â”œâ”€ Retour: text
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: IMMUTABLE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.urlencode(string character varying)
       RETURNS text
       LANGUAGE c
       IMMUTABLE STRICT
      AS '$libdir/http', $function$urlencode$function$
      

49. ğŸ”§ urlencode
   â”œâ”€ Arguments: string bytea
   â”œâ”€ Retour: text
   â”œâ”€ Langage: c
   â”œâ”€ VolatilitÃ©: IMMUTABLE
   â””â”€ DÃ©finition:
      CREATE OR REPLACE FUNCTION public.urlencode(string bytea)
       RETURNS text
       LANGUAGE c
       IMMUTABLE STRICT
      AS '$libdir/http', $function$urlencode$function$
      

ğŸ” 5. POLITIQUES RLS DÃ‰TAILLÃ‰ES
--------------------------------------------------------------------------------
ğŸ“Š Total: 69 policies


ğŸ“¦ TABLE: activation_packages

   ğŸ” Admin full access
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Public read access
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: activations

   ğŸ” Admins can read all activations
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Authenticated users can insert activations
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         (auth.uid() = user_id)

   ğŸ” Service role can manage activations
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {service_role}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Service role can update activations
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {service_role}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Service role full access
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {service_role}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Users can read own activations
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users insert own activations
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {anon,authenticated}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         ((user_id = auth.uid()) OR ((user_id)::text = ((current_setting('request.jwt.claims'::text, true))::json ->> 'sub'::text)))

   ğŸ” Users update own activations
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {anon,authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  ((user_id = auth.uid()) OR ((user_id)::text = ((current_setting('request.jwt.claims'::text, true))::json ->> 'sub'::text)))
      â””â”€ VÃ©rification (WITH CHECK):
         ((user_id = auth.uid()) OR ((user_id)::text = ((current_setting('request.jwt.claims'::text, true))::json ->> 'sub'::text)))

   ğŸ” Users view own activations
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {anon,authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  ((user_id = auth.uid()) OR ((user_id)::text = ((current_setting('request.jwt.claims'::text, true))::json ->> 'sub'::text)))
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: activity_logs

   ğŸ” Admins can view logs
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: contact_settings

   ğŸ” Admins can insert contact settings
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))

   ğŸ” Admins can update contact settings
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Anyone can read contact settings
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: countries

   ğŸ” Admins can manage countries
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Anyone can view active countries
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  ((active = true) OR (auth.uid() IS NOT NULL))
      â””â”€ Pas de WITH CHECK

   ğŸ” Authenticated users can view countries
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

   ğŸ” Public can view countries
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: favorite_services

   ğŸ” Users can manage own favorites
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: logs_provider

   ğŸ” Admins can view all logs
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Service role can insert logs
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         true

ğŸ“¦ TABLE: notifications

   ğŸ” Users can update own notifications
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can view own notifications
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: popular_services

   ğŸ” Admins can manage popular services
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (((auth.jwt() ->> 'role'::text) = 'admin'::text) OR ((auth.jwt() ->> 'user_role'::text) = 'admin'::text))
      â””â”€ Pas de WITH CHECK

   ğŸ” Public can view popular services
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: rental_messages

   ğŸ” Service role can insert rental messages
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Users can view their rental messages
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM rentals
  WHERE ((rentals.id = rental_messages.rental_id) AND (rentals.user_id = auth.uid()))))
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: rentals

   ğŸ” Admins can update all rentals
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Admins can view all rentals
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Service role full access rentals
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {service_role}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Users can create their own rentals
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         (auth.uid() = user_id)

   ğŸ” Users can insert own rentals
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         (auth.uid() = user_id)

   ğŸ” Users can update own rentals
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can update their own rentals
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can view own rentals
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can view their own rentals
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: service_icons

   ğŸ” Admins can manage service icons
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Anyone can view service icons
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

   ğŸ” Authenticated users can view service icons
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

   ğŸ” Public can view service icons
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: services

   ğŸ” Admins can manage services
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Anyone can view active services
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  ((active = true) OR (auth.uid() IS NOT NULL))
      â””â”€ Pas de WITH CHECK

   ğŸ” Anyone can view services
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

   ğŸ” Authenticated users can view services
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

   ğŸ” Public can view services
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: sms_messages

   ğŸ” System can insert messages
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Users can view own messages
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: system_logs

   ğŸ” Admin can view all logs
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” System can insert logs
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         true

ğŸ“¦ TABLE: system_settings

   ğŸ” Admin full access to system_settings
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Admins can manage settings
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: transactions

   ğŸ” Admins can view all transactions
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = ANY (ARRAY['admin'::text, 'super_admin'::text])))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can view own transactions
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {authenticated}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: users

   ğŸ” Admins can delete users
      â”œâ”€ Commande: DELETE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users users_1
  WHERE ((users_1.id = auth.uid()) AND (users_1.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Anyone can read users
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  true
      â””â”€ Pas de WITH CHECK

   ğŸ” Enable insert for authenticated users
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         (auth.uid() = id)

   ğŸ” Enable user registration
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         true

   ğŸ” Service role can manage all users
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  ((((current_setting('request.jwt.claims'::text, true))::json ->> 'role'::text) = 'service_role'::text) OR ((auth.uid() = id) AND (role = 'admin'::text)))
      â””â”€ Pas de WITH CHECK

   ğŸ” Service role full access
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (((current_setting('request.jwt.claims'::text, true))::json ->> 'role'::text) = 'service_role'::text)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users and admins can update
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  ((auth.uid() = id) OR (EXISTS ( SELECT 1
   FROM users users_1
  WHERE ((users_1.id = auth.uid()) AND (users_1.role = 'admin'::text)))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can update own data
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can view own data
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users update own profile
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: virtual_numbers

   ğŸ” Admins can view all numbers
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (EXISTS ( SELECT 1
   FROM users
  WHERE ((users.id = auth.uid()) AND (users.role = 'admin'::text))))
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can insert own numbers
      â”œâ”€ Commande: INSERT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â””â”€ VÃ©rification (WITH CHECK):
         (auth.uid() = user_id)

   ğŸ” Users can update own numbers
      â”œâ”€ Commande: UPDATE
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

   ğŸ” Users can view own numbers
      â”œâ”€ Commande: SELECT
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.uid() = user_id)
      â””â”€ Pas de WITH CHECK

ğŸ“¦ TABLE: webhook_logs

   ğŸ” Service role can manage webhook logs
      â”œâ”€ Commande: ALL
      â”œâ”€ RÃ´les: {public}
      â”œâ”€ Type: PERMISSIVE
      â”œâ”€ Condition (USING):
      â”‚  (auth.role() = 'service_role'::text)
      â””â”€ Pas de WITH CHECK

âš ï¸  TABLES SANS POLICIES RLS (2):
   âŒ balance_operations
   âŒ pricing_rules_archive

âš¡ 6. INDEX DÃ‰TAILLÃ‰S
--------------------------------------------------------------------------------
ğŸ“Š Total: 114 index

ğŸ” Top 10 plus gros index:

1. idx_services_name_search (256 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE INDEX idx_services_name_search ON public.services USING gin (to_tsvector(...
2. idx_services_popularity_sort (224 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE INDEX idx_services_popularity_sort ON public.services USING btree (popula...
3. idx_services_popularity (208 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE INDEX idx_services_popularity ON public.services USING btree (popularity_...
4. idx_services_icon_url (168 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE INDEX idx_services_icon_url ON public.services USING btree (icon_url) WHE...
5. services_pkey (168 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE UNIQUE INDEX services_pkey ON public.services USING btree (id)...
6. idx_services_code (160 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE INDEX idx_services_code ON public.services USING btree (code)...
7. services_code_key (160 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE UNIQUE INDEX services_code_key ON public.services USING btree (code)...
8. idx_service_icons_code (120 kB)
   â”œâ”€ Table: service_icons
   â””â”€ DÃ©finition: CREATE INDEX idx_service_icons_code ON public.service_icons USING btree (service...
9. idx_services_category (120 kB)
   â”œâ”€ Table: services
   â””â”€ DÃ©finition: CREATE INDEX idx_services_category ON public.services USING btree (category)...
10. service_icons_service_code_key (104 kB)
   â”œâ”€ Table: service_icons
   â””â”€ DÃ©finition: CREATE UNIQUE INDEX service_icons_service_code_key ON public.service_icons USING...


ğŸ“‹ Index par table:


ğŸ“¦ services:
   â”œâ”€ idx_services_name_search (256 kB)
   â”œâ”€ idx_services_popularity_sort (224 kB)
   â”œâ”€ idx_services_popularity (208 kB)
   â”œâ”€ idx_services_icon_url (168 kB)
   â”œâ”€ services_pkey (168 kB)
   â”œâ”€ idx_services_code (160 kB)
   â”œâ”€ services_code_key (160 kB)

ğŸ“¦ service_icons:
   â”œâ”€ idx_service_icons_code (120 kB)

ğŸ“¦ services:
   â”œâ”€ idx_services_category (120 kB)

ğŸ“¦ service_icons:
   â”œâ”€ service_icons_service_code_key (104 kB)

ğŸ“¦ services:
   â”œâ”€ idx_services_active (104 kB)

ğŸ“¦ service_icons:
   â”œâ”€ service_icons_pkey (88 kB)

ğŸ“¦ services:
   â”œâ”€ idx_services_category_active (72 kB)
   â”œâ”€ idx_services_provider (64 kB)

ğŸ“¦ transactions:
   â”œâ”€ idx_transactions_metadata (56 kB)

ğŸ“¦ countries:
   â”œâ”€ countries_code_key (40 kB)
   â”œâ”€ idx_countries_code (40 kB)
   â”œâ”€ countries_pkey (40 kB)

ğŸ“¦ transactions:
   â”œâ”€ transactions_pkey (40 kB)

ğŸ“¦ system_logs:
   â”œâ”€ idx_system_logs_metadata (24 kB)

ğŸ“¦ activations:
   â”œâ”€ idx_activations_order_id (16 kB)
   â”œâ”€ idx_activations_status (16 kB)
   â”œâ”€ idx_activations_created_at (16 kB)
   â”œâ”€ idx_activations_charged (16 kB)
   â”œâ”€ idx_activations_provider (16 kB)
   â”œâ”€ idx_activations_user_status (16 kB)
   â”œâ”€ idx_activations_frozen (16 kB)

ğŸ“¦ countries:
   â”œâ”€ idx_countries_active (16 kB)
   â”œâ”€ idx_countries_provider (16 kB)
   â”œâ”€ idx_countries_popularity (16 kB)
   â”œâ”€ idx_countries_display_order (16 kB)

ğŸ“¦ popular_services:
   â”œâ”€ idx_popular_services_type (16 kB)

ğŸ“¦ rental_messages:
   â”œâ”€ rental_messages_pkey (16 kB)
   â”œâ”€ idx_rental_messages_rental_id (16 kB)
   â”œâ”€ idx_rental_messages_rent_id (16 kB)
   â”œâ”€ idx_rental_messages_unique (16 kB)

ğŸ“¦ users:
   â”œâ”€ idx_users_email (16 kB)
   â”œâ”€ idx_users_role (16 kB)
   â”œâ”€ users_pkey (16 kB)
   â”œâ”€ users_email_key (16 kB)
   â”œâ”€ idx_users_frozen_balance (16 kB)

ğŸ“¦ transactions:
   â”œâ”€ idx_transactions_user_id (16 kB)
   â”œâ”€ idx_transactions_type (16 kB)
   â”œâ”€ idx_transactions_status (16 kB)
   â”œâ”€ idx_transactions_reference (16 kB)
   â”œâ”€ transactions_reference_key (16 kB)
   â”œâ”€ idx_transactions_related_rental_id (16 kB)

ğŸ“¦ activations:
   â”œâ”€ idx_activations_reconcile (16 kB)
   â”œâ”€ activations_pkey (16 kB)
   â”œâ”€ activations_order_id_key (16 kB)
   â”œâ”€ idx_activations_user_id (16 kB)

ğŸ“¦ rentals:
   â”œâ”€ idx_rentals_user_id (16 kB)
   â”œâ”€ idx_rentals_rent_id (16 kB)
   â”œâ”€ idx_rentals_status (16 kB)
   â”œâ”€ idx_rentals_created_at (16 kB)
   â”œâ”€ idx_rentals_frozen (16 kB)

ğŸ“¦ balance_operations:
   â”œâ”€ balance_operations_pkey (16 kB)
   â”œâ”€ idx_balance_ops_user (16 kB)
   â”œâ”€ idx_balance_ops_activation (16 kB)
   â”œâ”€ idx_balance_ops_rental (16 kB)
   â”œâ”€ idx_balance_ops_related_tx (16 kB)
   â”œâ”€ idx_balance_ops_type (16 kB)

ğŸ“¦ system_logs:
   â”œâ”€ system_logs_pkey (16 kB)
   â”œâ”€ idx_system_logs_created_at (16 kB)
   â”œâ”€ idx_system_logs_level (16 kB)
   â”œâ”€ idx_system_logs_category (16 kB)
   â”œâ”€ idx_system_logs_user_id (16 kB)

ğŸ“¦ logs_provider:
   â”œâ”€ logs_provider_pkey (16 kB)
   â”œâ”€ idx_logs_provider_provider (16 kB)
   â”œâ”€ idx_logs_provider_action (16 kB)
   â”œâ”€ idx_logs_provider_created_at (16 kB)
   â”œâ”€ idx_logs_provider_action_status (16 kB)

ğŸ“¦ popular_services:
   â”œâ”€ popular_services_pkey (16 kB)
   â”œâ”€ popular_services_service_code_country_code_type_key (16 kB)
   â”œâ”€ idx_popular_services_featured (16 kB)

ğŸ“¦ contact_settings:
   â”œâ”€ contact_settings_pkey (16 kB)

ğŸ“¦ system_settings:
   â”œâ”€ system_settings_pkey (16 kB)
   â”œâ”€ system_settings_key_key (16 kB)

ğŸ“¦ activation_packages:
   â”œâ”€ activation_packages_pkey (16 kB)
   â”œâ”€ activation_packages_activations_key (16 kB)
   â”œâ”€ idx_activation_packages_order (16 kB)
   â”œâ”€ idx_activation_packages_active (16 kB)

ğŸ“¦ rentals:
   â”œâ”€ idx_rentals_expires_at (16 kB)
   â”œâ”€ idx_rentals_rental_id (16 kB)
   â”œâ”€ idx_rentals_phone (16 kB)
   â”œâ”€ idx_rentals_service (16 kB)
   â”œâ”€ idx_rentals_country (16 kB)
   â”œâ”€ rentals_pkey (16 kB)
   â”œâ”€ rentals_rent_id_unique (16 kB)

ğŸ“¦ activity_logs:
   â”œâ”€ idx_activity_logs_user_id (8192 bytes)
   â”œâ”€ idx_activity_logs_created_at (8192 bytes)

ğŸ“¦ webhook_logs:
   â”œâ”€ idx_webhook_logs_created_at (8192 bytes)

ğŸ“¦ rentals:
   â”œâ”€ idx_rentals_reconcile (8192 bytes)

ğŸ“¦ activity_logs:
   â”œâ”€ activity_logs_pkey (8192 bytes)

ğŸ“¦ notifications:
   â”œâ”€ notifications_pkey (8192 bytes)
   â”œâ”€ idx_notifications_read (8192 bytes)
   â”œâ”€ idx_notifications_user_id (8192 bytes)

ğŸ“¦ favorite_services:
   â”œâ”€ favorite_services_user_id_service_code_country_key (8192 bytes)
   â”œâ”€ favorite_services_pkey (8192 bytes)

ğŸ“¦ sms_messages:
   â”œâ”€ sms_messages_pkey (8192 bytes)
   â”œâ”€ idx_sms_messages_user_id (8192 bytes)
   â”œâ”€ idx_sms_messages_virtual_number_id (8192 bytes)

ğŸ“¦ countries:
   â”œâ”€ idx_countries_flag_url (8192 bytes)

ğŸ“¦ virtual_numbers:
   â”œâ”€ virtual_numbers_external_id_key (8192 bytes)
   â”œâ”€ virtual_numbers_pkey (8192 bytes)
   â”œâ”€ idx_virtual_numbers_external_id (8192 bytes)
   â”œâ”€ idx_virtual_numbers_status (8192 bytes)

ğŸ“¦ logs_provider:
   â”œâ”€ idx_logs_provider_user_id (8192 bytes)
   â”œâ”€ idx_logs_provider_activation_id (8192 bytes)

ğŸ“¦ virtual_numbers:
   â”œâ”€ idx_virtual_numbers_user_id (8192 bytes)

ğŸ“¦ logs_provider:
   â”œâ”€ idx_logs_provider_error (8192 bytes)

ğŸ“¦ webhook_logs:
   â”œâ”€ webhook_logs_pkey (8192 bytes)
   â”œâ”€ idx_webhook_logs_activation_id (8192 bytes)
   â”œâ”€ idx_webhook_logs_processed (8192 bytes)

ğŸ§Š 7. ANALYSE FROZEN AMOUNTS LOGIC
--------------------------------------------------------------------------------
ğŸ”§ Fonctions liÃ©es au frozen:


1. Fonction:
CREATE OR REPLACE FUNCTION public.fix_frozen_balance_discrepancy(p_user_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_calculated DECIMAL(10,2);
    v_actual DECIMAL(10,2);
    v_balance DECIMAL(10,2);
    v_activation_frozen DECIMAL(10,2);
    v_rental_frozen DECIMAL(10,2);
BEGIN
    -- Calculer ce que frozen_balance DEVRAIT Ãªtre (activations)
    SELECT COALESCE(SUM(frozen_amount), 0)
    INTO v_activation_frozen
    FROM activations
    WHERE user_id = p_user_id
    AND status IN ('pending', 'waiting')
    AND frozen_amount > 0;
    
    -- Calculer ce que frozen_balance DEVRAIT Ãªtre (rentals)
    SELECT COALESCE(SUM(frozen_amount), 0)
    INTO v_rental_frozen
    FROM rentals
    WHERE user_id = p_user_id
    AND status = 'active'
    AND frozen_amount > 0;
    
    -- Total
    v_calculated := v_activation_frozen + v_rental_frozen;
    
    -- RÃ©cupÃ©rer les valeurs actuelles
    SELECT balance, COALESCE(frozen_balance, 0)
    INTO v_balance, v_actual
    FROM users
    WHERE id = p_user_id
    FOR UPDATE;
    
    -- Si pas de diffÃ©rence significative, retourner
    IF ABS(v_actual - v_calculated) < 0.01 THEN
        RETURN jsonb_build_object(
            'success', true,
            'correction_needed', false,
            'frozen_balance', v_actual,
            'activation_frozen', v_activation_frozen,
            'rental_frozen', v_rental_frozen
        );
    END IF;
    
    -- Corriger
    UPDATE users
    SET frozen_balance = v_calculated
    WHERE id = p_user_id;
    
    -- Logger la correction
    INSERT INTO balance_operations (
        user_id, activation_id, operation_type, amount,
        balance_before, balance_after,
        frozen_before, frozen_after,
        reason, metadata
    ) VALUES (
        p_user_id, NULL, 'correction', v_actual - v_calculated,
        v_balance, v_balance,
        v_actual, v_calculated,
        'Automatic frozen balance reconciliation',
        jsonb_build_object(
            'old_frozen', v_actual,
            'new_frozen', v_calculated,
            'difference', v_actual - v_calculated,
            'activation_frozen', v_activation_frozen,
            'rental_frozen', v_rental_frozen
        )
    );
    
    RETURN jsonb_build_object(
        'success', true,
        'correction_needed', true,
        'old_frozen', v_actual,
        'new_frozen', v_calculated,
        'difference', v_actual - v_calculated,
        'activation_frozen', v_activation_frozen,
        'rental_frozen', v_rental_frozen
    );
END;
$function$



2. Fonction:
CREATE OR REPLACE FUNCTION public.prevent_direct_frozen_amount_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- Permettre aux fonctions SECURITY DEFINER (atomic_*) d'opÃ©rer
  IF current_user = 'postgres' THEN
    RETURN NEW;
  END IF;
  
  -- Bloquer les modifications directes
  IF OLD.frozen_balance IS DISTINCT FROM NEW.frozen_balance THEN
    RAISE EXCEPTION 'Direct update of frozen_amount is forbidden. Use atomic_freeze, atomic_commit, or atomic_refund functions.';
  END IF;
  
  RETURN NEW;
END;
$function$



3. Fonction:
CREATE OR REPLACE FUNCTION public.reconcile_frozen_balance(p_user_id uuid)
 RETURNS TABLE(calculated_frozen numeric, actual_frozen numeric, difference numeric, needs_correction boolean)
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_calculated DECIMAL(10,2);
    v_actual DECIMAL(10,2);
    v_activation_frozen DECIMAL(10,2);
    v_rental_frozen DECIMAL(10,2);
BEGIN
    -- Calculer la somme des frozen_amount pour les activations actives
    SELECT COALESCE(SUM(frozen_amount), 0)
    INTO v_activation_frozen
    FROM activations
    WHERE user_id = p_user_id
    AND status IN ('pending', 'waiting')
    AND frozen_amount > 0;
    
    -- Calculer la somme des frozen_amount pour les rentals actives
    SELECT COALESCE(SUM(frozen_amount), 0)
    INTO v_rental_frozen
    FROM rentals
    WHERE user_id = p_user_id
    AND status = 'active'
    AND frozen_amount > 0;
    
    -- Total calculÃ©
    v_calculated := v_activation_frozen + v_rental_frozen;
    
    -- RÃ©cupÃ©rer le frozen_balance actuel
    SELECT COALESCE(frozen_balance, 0)
    INTO v_actual
    FROM users
    WHERE id = p_user_id;
    
    RETURN QUERY SELECT 
        v_calculated,
        v_actual,
        v_actual - v_calculated,
        ABS(v_actual - v_calculated) > 0.01;
END;
$function$


âš¡ Triggers protect_frozen_amount:


ğŸ“¦ activations:
   Trigger: protect_frozen_amount_activations
   DÃ©finition: CREATE TRIGGER protect_frozen_amount_activations BEFORE UPDATE ON public.activations FOR EACH ROW EXECUTE FUNCTION prevent_direct_frozen_amount_update()

ğŸ“¦ rentals:
   Trigger: protect_frozen_amount_rentals
   DÃ©finition: CREATE TRIGGER protect_frozen_amount_rentals BEFORE UPDATE ON public.rentals FOR EACH ROW EXECUTE FUNCTION prevent_direct_frozen_amount_update()

ğŸ“¦ users:
   Trigger: prevent_direct_frozen_amount_update
   DÃ©finition: CREATE TRIGGER prevent_direct_frozen_amount_update BEFORE UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION prevent_direct_frozen_amount_update()


ğŸ“Š Ã‰tat actuel des frozen amounts:

ğŸ‘¥ Users:
   â”œâ”€ Avec frozen: 2/45
   â”œâ”€ Total frozen: 70 XOF
   â””â”€ Max frozen: 60 XOF

ğŸ“± Activations avec frozen:
   â”œâ”€ pending: 5 (70 XOF)
   â”œâ”€ received: 1 (5 XOF)

ğŸ  Rentals avec frozen:
   â”œâ”€ active: 3 (15 XOF)


âš ï¸  INCOHÃ‰RENCES FROZEN:

âŒ 1 utilisateurs avec incohÃ©rence:

buba6c@gmail.com:
   â”œâ”€ Frozen user: 60 XOF
   â”œâ”€ Frozen activations: 195 XOF
   â”œâ”€ Frozen rentals: 60 XOF
   â”œâ”€ Total attendu: 255 XOF
   â””â”€ DiffÃ©rence: -195 XOF

ğŸ’¼ 8. ANALYSE BALANCE OPERATIONS
--------------------------------------------------------------------------------
ğŸ“‹ Structure de balance_operations:

   â”œâ”€ id: uuid NOT NULL DEFAULT gen_random_uuid()
   â”œâ”€ user_id: uuid NOT NULL
   â”œâ”€ activation_id: uuid NULL
   â”œâ”€ rental_id: uuid NULL
   â”œâ”€ related_transaction_id: uuid NULL
   â”œâ”€ operation_type: text NOT NULL
   â”œâ”€ amount: numeric NOT NULL
   â”œâ”€ balance_before: numeric NOT NULL
   â”œâ”€ balance_after: numeric NOT NULL
   â”œâ”€ frozen_before: numeric NOT NULL
   â”œâ”€ frozen_after: numeric NOT NULL
   â”œâ”€ reason: text NULL
   â”œâ”€ metadata: jsonb NULL DEFAULT '{}'::jsonb
   â”œâ”€ created_at: timestamp without time zone NULL DEFAULT now()


ğŸ“Š Stats par type d'opÃ©ration:

freeze:
   â”œâ”€ Nombre: 116
   â”œâ”€ Total: 774 XOF
   â”œâ”€ Moyenne: 6,672 XOF
   â”œâ”€ PremiÃ¨re: 02/12/2025 22:12:35
   â””â”€ DerniÃ¨re: 04/12/2025 16:30:33
refund:
   â”œâ”€ Nombre: 91
   â”œâ”€ Total: 590 XOF
   â”œâ”€ Moyenne: 6,484 XOF
   â”œâ”€ PremiÃ¨re: 02/12/2025 23:23:26
   â””â”€ DerniÃ¨re: 03/12/2025 22:35:52
commit:
   â”œâ”€ Nombre: 1
   â”œâ”€ Total: 5 XOF
   â”œâ”€ Moyenne: 5 XOF
   â”œâ”€ PremiÃ¨re: 03/12/2025 01:30:19
   â””â”€ DerniÃ¨re: 03/12/2025 01:30:19


âš ï¸  OPÃ‰RATIONS PROBLÃ‰MATIQUES:

âŒ 10 opÃ©rations avec calcul incorrect:

1. freeze - buba6c@gmail.com
   â”œâ”€ Balance avant: 60
   â”œâ”€ Montant: 50
   â”œâ”€ Balance aprÃ¨s (attendue): 110
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 60
   â””â”€ DiffÃ©rence: -50
2. freeze - kawdpc@gmail.com
   â”œâ”€ Balance avant: 143
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 148
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 143
   â””â”€ DiffÃ©rence: -5
3. freeze - kawdpc@gmail.com
   â”œâ”€ Balance avant: 143
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 148
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 143
   â””â”€ DiffÃ©rence: -5
4. refund - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5
5. refund - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5
6. refund - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5
7. freeze - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5
8. freeze - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5
9. freeze - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5
10. freeze - buba6c@gmail.com
   â”œâ”€ Balance avant: 55
   â”œâ”€ Montant: 5
   â”œâ”€ Balance aprÃ¨s (attendue): 60
   â”œâ”€ Balance aprÃ¨s (rÃ©elle): 55
   â””â”€ DiffÃ©rence: -5


ğŸ† Top 5 users par opÃ©rations:

1. buba6c@gmail.com: 178 opÃ©rations (1â€¯138 XOF)
2. kawdpc@gmail.com: 28 opÃ©rations (221 XOF)
3. buba-test-1764770395684@example.com: 2 opÃ©rations (10 XOF)

ğŸ‘ï¸  9. VUES (VIEWS)
--------------------------------------------------------------------------------
ğŸ“Š Total: 9 vues


1. ğŸ‘ï¸  activation_stats
   DÃ©finition:
    SELECT user_id,
    count(*) AS total_activations,
    count(*) FILTER (WHERE (status = 'received'::text)) AS successful_activations,
    count(*) FILTER (WHERE (status = 'timeout'::text)) AS timeout...

2. ğŸ‘ï¸  available_services
   DÃ©finition:
    SELECT DISTINCT activations.service_code,
    activations.country_code,
    'activation'::text AS type,
    count(*) AS usage_count,
    max(activations.created_at) AS last_used
   FROM activations
 ...

3. ğŸ‘ï¸  v_country_health
   DÃ©finition:
    SELECT country_code,
    count(*) AS total_activations_24h,
    sum(
        CASE
            WHEN (status = 'received'::text) THEN 1
            ELSE 0
        END) AS successful_activations,
    ro...

4. ğŸ‘ï¸  v_dashboard_stats
   DÃ©finition:
    SELECT count(*) AS total_activations_24h,
    sum(
        CASE
            WHEN (status = 'received'::text) THEN 1
            ELSE 0
        END) AS successful_24h,
    sum(
        CASE
          ...

5. ğŸ‘ï¸  v_frozen_balance_health
   DÃ©finition:
    SELECT (( SELECT COALESCE(sum(activations.frozen_amount), (0)::numeric) AS "coalesce"
           FROM activations
          WHERE ((activations.status = ANY (ARRAY['pending'::text, 'waiting'::text]))...

6. ğŸ‘ï¸  v_frozen_balance_health_reconciliation
   DÃ©finition:
    WITH user_frozen_sums AS (
         SELECT combined.user_id,
            COALESCE(sum(combined.frozen_amount), (0)::numeric) AS total_frozen_activations
           FROM ( SELECT activations.user_id,
...

7. ğŸ‘ï¸  v_provider_stats_24h
   DÃ©finition:
    SELECT provider,
    action,
    count(*) AS total_calls,
    count(*) FILTER (WHERE (response_status = 200)) AS success_count,
    count(*) FILTER (WHERE (error_message IS NOT NULL)) AS error_count,...

8. ğŸ‘ï¸  v_service_health
   DÃ©finition:
    SELECT service_code,
    count(*) AS total_activations_24h,
    sum(
        CASE
            WHEN (status = 'received'::text) THEN 1
            ELSE 0
        END) AS successful_activations,
    su...

9. ğŸ‘ï¸  v_service_response_time
   DÃ©finition:
    SELECT service_code,
    count(*) AS successful_count,
    round(avg((EXTRACT(epoch FROM (sms_received_at - created_at)) / (60)::numeric)), 1) AS avg_wait_minutes,
    round(min((EXTRACT(epoch FROM (...

ğŸ”¢ 10. SEQUENCES
--------------------------------------------------------------------------------
â„¹ï¸  Aucune sÃ©quence trouvÃ©e (utilisation de UUID)

ğŸ§© 11. EXTENSIONS POSTGRESQL
--------------------------------------------------------------------------------
ğŸ“Š Total: 9 extensions

1. http (v1.6)
2. pg_cron (v1.6.4)
3. pg_graphql (v1.5.11)
4. pg_net (v0.19.5)
5. pg_stat_statements (v1.11)
6. pgcrypto (v1.3)
7. plpgsql (v1.0)
8. supabase_vault (v0.3.1)
9. uuid-ossp (v1.1)

ğŸ“ˆ 12. STATISTIQUES DES TABLES
--------------------------------------------------------------------------------
âŒ Erreur: column "tablename" does not exist

================================================================================
âœ… ANALYSE SQL COMPLÃˆTE TERMINÃ‰E
================================================================================
